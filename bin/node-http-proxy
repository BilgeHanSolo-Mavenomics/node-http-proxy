#!/usr/bin/env node

'use strict'

var program = require('commander')
var pm2     = require('pm2')

program.on('--help',function(){
    console.log("  ================Basic Example===============")
    console.log('')
    console.log('  Command: nproxy -p 8888 -i 1')
    console.log('')
})


var commanders = {
instance:{params:'-i --instance [i]',comment:'child process,0 means use max cpu cores',sn:'-i'},
    port:{params:'-p --port [p]',comment:'listen port',sn:'-p'},
    debug:{params:'-d --debug',comment:'open debug mode'},
    daemon:{params:'-D --daemon',comment:'run proxy server daemon'}
}


var argvs = [];


//set version
program.version('0.0.1');

//register params
for(var c in commanders){
    program.option(commanders[c]['params'],commanders[c]['comment']);
}

//parse argv
program.parse(process.argv);

//init argvs
for(var c in commanders){
    if(program[c] != undefined && commanders[c]['sn'] != undefined){
		argvs.push(commanders[c]['sn']);	
		argvs.push(program[c]);
    }

}


if(argvs.debug != undefined){
    console.log(' ====== argvs',argvs);
}



pm2.connect(function(){
    pm2.start(__dirname + '/main.js',{name:'http-proxy',scriptArgs:argvs},function(err,proc){
        if(err && argvs.debug) console.trace(err);
        pm2.disconnect(function(){
           process.exit(0);
        });
    });
})






